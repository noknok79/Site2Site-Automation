# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  - name: MS365ENT_ENVIRONMENT
    value: ms365ent
  - name: CONTOSO_ENVIRONMENT
    value: contoso

stages:
  - stage: PublishArtifactsPipeline
    jobs:
      - job: PublishArtifactsPipeline
        continueOnError: false
        steps:
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: "$$(System.DefaultWorkingDirectory)/contoso"
              artifact: "contoso-out"
              publishLocation: "pipeline"

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(System.ArtifactsDirectory)'
              ArtifactName: 'drop'
              publishLocation: 'Container'


  - stage: WhatIfContosoResources
    jobs:
      - deployment: WhatIfContosoResources
        continueOnError: true
        displayName: What-If Contoso Resources
        #dependsOn: DeployQAAKSCluster
        environment: $(CONTOSO_ENVIRONMENT)
        strategy:
          runOnce:
            deploy:
              steps:    
                - task: DownloadBuildArtifacts@0
                  inputs:
                    buildType: 'current'
                    artifactName: 'drop'
                    downloadPath: '$(System.ArtifactsDirectory)'
          
                - task: AzureCLI@2
                  displayName: What-If Resources
                  inputs:
                    azureSubscription: "contoso-test-bicep-rg-connection"
                    scriptType: "bash"
                    scriptLocation: "inlineScript"
                    inlineScript: |
                      az deployment group what-if --resource-group test-bicep-rg --template-file publicip2.bicep
                      az deployment group what-if --resource-group test-bicep-rg --template-file publicip3.bicep
                      az deployment group what-if --resource-group test-bicep-rg --template-file contosovnet1.bicep
                      az deployment group what-if --resource-group test-bicep-rg --template-file contosovm1-ip.bicep
                      az deployment group what-if --resource-group test-bicep-rg --template-file contosovm1-nsg.bicep
                      az deployment group what-if --resource-group test-bicep-rg --template-file contosovm1402.bicep
                      az deployment group what-if --resource-group test-bicep-rg --template-file contosovm1.bicep
                      az deployment group what-if --resource-group test-bicep-rg --template-file contosovm1_OsDisk_1_8c2c78cabbab408fa190353d86b1fc56.bicep
                      az deployment group what-if --resource-group test-bicep-rg --template-file contosovnet1-bastion.bicep
                      az deployment group what-if --resource-group test-bicep-rg --template-file locgateway.bicep
                      az deployment group what-if --resource-group test-bicep-rg --template-file contosovirtnetgw.bicep
                      az deployment group what-if --resource-group test-bicep-rg --template-file s2s-connect-to-ms365ent.bicep
                    workingDirectory: "$(System.ArtifactsDirectory)/contoso-out"

                - task: AzureCLI@2
                  displayName: Create Resources
                  inputs:
                    azureSubscription: "contoso-test-bicep-rg-connection"
                    scriptType: "bash"
                    scriptLocation: "inlineScript"
                    inlineScript: |
                      az deployment group create --resource-group test-bicep-rg --template-file publicip2.bicep
                      az deployment group create --resource-group test-bicep-rg --template-file publicip3.bicep
                      az deployment group create --resource-group test-bicep-rg --template-file contosovnet1.bicep
                      az deployment group create --resource-group test-bicep-rg --template-file contosovm1-ip.bicep
                      az deployment group create --resource-group test-bicep-rg --template-file contosovm1-nsg.bicep
                      az deployment group create --resource-group test-bicep-rg --template-file contosovm1402.bicep
                      az deployment group create --resource-group test-bicep-rg --template-file contosovm1.bicep
                      az deployment group create --resource-group test-bicep-rg --template-file contosovnet1-bastion.bicep
                      az deployment group create --resource-group test-bicep-rg --template-file locgateway.bicep
                      az deployment group create --resource-group test-bicep-rg --template-file contosovirtnetgw.bicep
                      az deployment group create --resource-group test-bicep-rg --template-file contosovm1_OsDisk_1_8c2c78cabbab408fa190353d86b1fc56.bicep
                      az deployment group create --resource-group test-bicep-rg --template-file s2s-connect-to-ms365ent.bicep
                    workingDirectory: "$(System.ArtifactsDirectory)/contoso-out"
